# ckb-contract-toolchains

A customized Rust toolchain for building CKB smart contracts. Some of the highlights are:

* RISC-V B extension is enabled by default
* An accompanying GNU toolchain is provided for now to build C code
* A new Rust target `riscv64imac_zba_zbb_zbc_zbs-unknown-ckb-elf` enables `std` in Rust
* Other useful optimizations for CKB, e.g.:
    + All stderr output will be automatically emitted to CKB's debug output

Notice all the changes made here are optimizations. CKB-VM still strictly obeys RISC-V specification, which means the official Rust toolchain / GNU toolchain can still be used to build CKB smart contracts.

## Usage

### Native Binary Package

Right now native binary `ckb-contract-toolchains` release only supports Ubuntu 22.04 running on x86_64 architecture.

In case you are on a bare minimal environment(such as the official jammy docker image), a few basic dependencies are required:

```bash
$ # If you are on absolute bare minimal machine, install sudo first:
$ apt-get update && apt-get install sudo
$ # Now install 2 dependencies used by installation tool
$ sudo apt-get install lsb-release curl
```

[rustup](https://rustup.rs/) is also needed here, please refer to rustup's installation steps.

Now use the following command to install the toolchain:

```bash
$ curl -f https://raw.githubusercontent.com/xxuejie/ckb-contract-toolchains/main/install.sh | bash
```

When succeeded, the final message generated by the installation script will show the new Rust toolchain version installed.

You can also manually list all installed toolchains:

```
$ rustup toolchain list
```

All toolchains provided by this repo starts with `ckb`.

### Docker

A docker image has been made available [here](https://hub.docker.com/r/xxuejie/ckb-contract-toolchains/tags). You can use it pretty much like [ckb-riscv-gnu-toolchain](https://hub.docker.com/r/nervos/ckb-riscv-gnu-toolchain/tags):

```bash
$ docker run --rm -it docker.io/xxuejie/ckb-contract-toolchains:20230316-1 bash
```

## Build from source

First, install build dependencies:

```bash
$ sudo apt-get install build-essential git lsb-release curl autoconf automake autotools-dev curl python3 libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev ninja-build cmake pkg-config libssl-dev
```

Use the following command to trigger build:

```bash
$ ./build.sh
```

When completed, there will be a folder named `dist_20230316-1` generated,
depending on the actual build version, the folder name might be slightly
different but they will all start with `dist_`. You can use the following
command to install locally built packages:

```bash
$ ./dist_20230316-1/install_local.sh
```
