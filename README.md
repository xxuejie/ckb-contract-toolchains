# NOTE

We have tried this path, and learned a lot alongside the journey of building a custom Rust toolchain. Most of the optimizations applied here, can also be applied on a normal toolchain with some tweaking of parameters, see the following commits for some examples:

* https://github.com/xxuejie/ckb-zero-lock/commit/0e8a6d001b8e158c24e91f65c72e92d2eb2aea26
* https://github.com/xxuejie/mmr-post-demo/commit/709da2bd83ea7f09c58cd60d5daa17c8d99be122

The only remaining part that is not directly applicable to the official Rust toolchain, is the `std` part. We do enable an `std` crate here in this custom Rust toolchain. Unfortunately, there are more elements intrinsic to porting `std` in Rust to a new architecture. In many places, crates are not assuming `std` alone, but doing inferring work on `target_os` as well:

* https://github.com/rust-random/getrandom/blob/2e483d68aaa57168a84489349d6473b492e05478/src/lib.rs#L219-L292
* https://github.com/dylni/os_str_bytes/blob/71033fe1bec5610a57457d4d0e4626c3d5570cef/src/common/mod.rs#L9-L18

It would not be feasible work for us to persuade every related crate out there to introduce `ckb` as a supported `target_os` of Rust. This means having an `std` crate in the custom Rust toolchain is not enough, we will need to patch certain crates to make things work. And if we are patching crates already, we could simply choose to patch those crates so the `std` related part is commented out.

Given those thoughts, a custom Rust toolchain here, does not really provide more benefits over an official Rust distribution. Hence we are deprecating this toolchain for now in favor of the official Rust compiler set.

# ckb-contract-toolchains

A customized Rust toolchain for building CKB smart contracts. Some of the highlights are:

* RISC-V B extension is enabled by default
* clang is leveraged to build C code, so we can deal with LLVM solely
* A new Rust target `riscv64imac_zba_zbb_zbc_zbs-unknown-ckb-elf` enables `std` in Rust
* Other useful optimizations for CKB, e.g.:
    + All stderr output will be automatically emitted to CKB's debug output

Notice all the changes made here are optimizations. CKB-VM still strictly obeys RISC-V specification, which means the official Rust toolchain / GNU toolchain can still be used to build CKB smart contracts.

## Usage

### Native Binary Package

Right now native binary `ckb-contract-toolchains` release supports Linux running on x64 and aarch64 platforms, as well as macOS running on Intel and Apple Silicon.

In case you are on a bare minimal environment(such as the official jammy docker image), a few basic dependencies are required:

```bash
$ # If you are on absolute bare minimal machine, install sudo first:
$ apt-get update && apt-get install sudo
$ # Now install dependencies used by installation tool
$ sudo apt-get install curl
```

The exact steps might vary depending on your OS.

[rustup](https://rustup.rs/) is also needed here, please refer to rustup's installation steps.

Now use the following command to install the toolchain:

```bash
$ curl -f https://raw.githubusercontent.com/xxuejie/ckb-contract-toolchains/main/install.sh | bash
```

When succeeded, the final message generated by the installation script will show the new Rust toolchain version installed.

You can also manually list all installed toolchains:

```
$ rustup toolchain list
```

All toolchains provided by this repo starts with `ckb`.

### Docker

A docker image has been made available [here](https://hub.docker.com/r/xxuejie/ckb-contract-toolchains/tags). You can use it pretty much like [ckb-riscv-gnu-toolchain](https://hub.docker.com/r/nervos/ckb-riscv-gnu-toolchain/tags):

```bash
$ docker run --rm -it docker.io/xxuejie/ckb-contract-toolchains:20230504-1 bash
```

## Build from source

Depending on your specific OS, different steps are required to install dependencies at build time. Here we include installation steps for certain OSes, but please understand that there is no way we can maintain an exhaustive list.

### Ubuntu

On Ubuntu, the following commands can be used:

```bash
$ sudo apt-get install cmake pkg-config libssl-dev git lsb-release curl autoconf automake autotools-dev curl python3 libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev ninja-build
```

### Fedora

On Fedora 37, the following commands can be used:

```bash
$ sudo yum install diffutils openssl-devel git cmake make autoconf automake python3 libmpc-devel mpfr-devel gmp-devel gawk  bison flex texinfo patchutils gcc gcc-c++ zlib-devel expat-devel ninja-build
```

### Arch Linux

On Arch Linux, the following commands can be used:

```bash
$ sudo pacman -Syyu ninja openssl cmake git autoconf automake curl python3 libmpc mpfr gmp gawk base-devel bison flex texinfo gperf libtool patchutils bc zlib expat
```

### macOS

To install dependencies, the following commands leveraging [homebrew](https://brew.sh/) can be used:

```bash
$ brew install coreutils gawk gnu-sed gmp mpfr libmpc isl zlib expat flock cmake pkg-config ninja openssl texinfo autoconf
```

### General Steps

Note that [rustup](https://rustup.rs/) is also a dependency used to manage Rust toolchain.

When the dependencies are installed, use the following command to build and install from source:

```bash
$ ./install_from_source.sh
```

## Uninstalling

To uninstall `ckb-contract-toolchains`, use the following command:

```bash
$ curl -f https://raw.githubusercontent.com/xxuejie/ckb-contract-toolchains/main/uninstall.sh | bash
```
